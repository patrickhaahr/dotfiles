{
  "version": 3,
  "sources": ["../notificator.js"],
  "sourcesContent": ["import { fileURLToPath } from 'url'\nimport { dirname, join } from 'path'\nimport { readFileSync, readdirSync } from 'fs'\n\nconst __filename = fileURLToPath(import.meta.url)\nconst __dirname = dirname(__filename)\n\nfunction stripJsonComments(str) {\n  return str\n    .replace(/\\/\\/.*$/gm, '')       // Remove single-line comments\n    .replace(/\\/\\*[\\s\\S]*?\\*\\//g, '') // Remove multi-line comments\n}\n\nfunction loadConfig() {\n  try {\n    const configPath = join(__dirname, 'notificator.jsonc')\n    const content = readFileSync(configPath, 'utf-8')\n    const stripped = stripJsonComments(content)\n    return JSON.parse(stripped)\n  } catch (err) {\n    console.error('Failed to load notificator.jsonc config:', err.message)\n    return {}\n  }\n}\n\n// Simple string hash function\nfunction hashString(str) {\n  let hash = 0\n  for (let i = 0; i < str.length; i++) {\n    const char = str.charCodeAt(i)\n    hash = ((hash << 5) - hash) + char\n    hash = hash & hash // Convert to 32-bit integer\n  }\n  return Math.abs(hash)\n}\n\nfunction getSoundFiles() {\n  try {\n    const soundsDir = join(__dirname, 'notificator-sounds')\n    const files = readdirSync(soundsDir)\n      .filter(f => /\\.(mp3|wav|ogg|m4a|aac|flac)$/i.test(f))\n      .sort()\n    return files.length > 0 ? files : ['ding1.mp3']\n  } catch {\n    return ['ding1.mp3']\n  }\n}\n\nfunction pickSoundFile(projectPath, seed) {\n  const soundFiles = getSoundFiles()\n  const input = `${projectPath}:${seed}`\n  const hash = hashString(input)\n  const index = hash % soundFiles.length\n  return soundFiles[index]\n}\n\nlet currentSessionID = null\n\nexport const NotificationPlugin = async ({ project, client, $, directory, worktree }) => {\n  const config = loadConfig()\n  const enabled = config.enabled !== false\n  const desktopNotificationConfig = config.showDesktopNotification || {}\n  const desktopNotificationEnabled = desktopNotificationConfig.enabled !== false\n  const soundConfig = config.playSound || {}\n  const soundEnabled = soundConfig.enabled !== false\n  \n  // Determine sound file: explicit file takes priority, then fileSeed, then directory-based with session ID\n  let soundFile\n  if (soundConfig.file) {\n    soundFile = soundConfig.file\n  } else if (soundConfig.fileSeed !== undefined) {\n    soundFile = pickSoundFile(worktree || directory, soundConfig.fileSeed)\n  } else if (currentSessionID !== null) {\n    soundFile = pickSoundFile(worktree || directory, currentSessionID)\n  } else {\n    soundFile = pickSoundFile(worktree || directory, hashString(worktree || directory))\n  }\n\n  const playNotificationSound = async () => {\n    if (!enabled || !soundEnabled) return\n    \n    const soundPath = join(__dirname, 'notificator-sounds', soundFile)\n    const platform = process.platform\n    \n    try {\n      if (platform === \"darwin\") {\n        await $`afplay \"${soundPath}\"`.quiet()\n      } else if (platform === \"linux\") {\n        // ffplay handles MP3 properly and is commonly available via ffmpeg\n        await $`ffplay -nodisp -autoexit -loglevel quiet ${soundPath}`.quiet()\n      }\n    } catch (err) {\n      // Silently fail - audio is not critical\n    }\n  }\n\n  const sendNotification = async (title, message) => {\n    if (!enabled || !desktopNotificationEnabled) return\n    \n    const platform = process.platform\n\n    try {\n      if (platform === \"darwin\") {\n        const escapedMessage = message.replace(/'/g, \"'\\\"'\\\"'\")\n        const escapedTitle = title.replace(/'/g, \"'\\\"'\\\"'\")\n        await $`osascript -e 'display notification \"${escapedMessage}\" with title \"${escapedTitle}\"'`\n      } else if (platform === \"linux\") {\n        await $`notify-send ${title} ${message}`\n      }\n    } catch (err) {\n      console.error('Failed to send notification:', err.message)\n    }\n  }\n\n  return {\n    event: async ({ event }) => {\n      if (event.type === \"session.created\" && event.sessionID) {\n        currentSessionID = event.sessionID\n      }\n      if (event.type === \"session.idle\") {\n        await sendNotification(\"OpenCode\", \"Generation completed\")\n        await playNotificationSound()\n      }\n    },\n    \"permission.ask\": async (input, output) => {\n      const message = `Permission request: ${input.type}`\n      await sendNotification(\"OpenCode\", message)\n      await playNotificationSound()\n    },\n  }\n}\n"],
  "mappings": "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",
  "names": []
}
